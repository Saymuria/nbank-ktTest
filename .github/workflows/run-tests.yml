name: Run tests

#триггер
on: [ push, workflow_dispatch ]
jobs:
  run-tests: #аналог этапов
    name: Set up services (review apps) and run tests
    runs-on: ubuntu-latest
    steps: #шаги конректной джобы
      - name: Checkout repository #копируем файлы репозитория внутрь СI агента
        uses: actions/checkout@v4
      - name: Set up jdk
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '21'
      - name: Chache gradle repository
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
      - name: Set up services
        run: cd infra/docker_compose && bash restart_docker.sh && cd ../..
      - name: Install Allure
        uses: simple-elf/allure-report-action@master
        with:
         allure-version: 2.27.0
      - name: Run tests
        run: ./gradlew clean test
        env:
          APIBASEURL: http://localhost:4111
          UIBASEURL: http://frontend:80
          UIREMOTE: http://localhost:4444/wd/hub
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: build/reports/tests/
          retention-days: 1
      - name: Publish Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
         allure_results: target/allure-results
         gh_pages: gh-pages
         allure_report: allure-report
      - name: Upload Allure report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report
          path: allure-report/
          retention-days: 1